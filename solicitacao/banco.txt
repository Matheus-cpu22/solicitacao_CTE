CREATE DATABASE Site;
USE Site;

CREATE TABLE tblsolicitacao(
	id INT PRIMARY KEY AUTO_INCREMENT,
	nomeMotorista VARCHAR(130) NOT NULL,
	placaCavalo VARCHAR(8) NOT NULL,
	placaCarretas VARCHAR(20) NOT NULL,
	destino VARCHAR(20) NOT NULL,
	valorOperacao DECIMAL(10,2) NOT NULL,
	tipoOperacao ENUM('CT-e','MDF-e','CT-e E MDF-e') NOT NULL,
	observacaoSolicitacao TEXT NOT NULL,
	observacaoExtra TEXT NULL,
	arquivoPDF VARCHAR(255) NULL,
	status ENUM('Pendente','Concluído') DEFAULT 'Pendente' NOT NULL,
	dataSolicitacao TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	dataConclusao TIMESTAMP NULL
);

-- Indices para consultas mais optimizadas
CREATE INDEX idx_tipoOperacao ON tblsolicitacao(tipoOperacao);
CREATE INDEX idx_status ON tblsolicitacao(STATUS);

CREATE TABLE tblarquivado(
	id INT PRIMARY KEY,
	nomeMotorista VARCHAR(130) NOT NULL,
	placaCavalo VARCHAR(8) NOT NULL,
	placaCarretas VARCHAR(20) NOT NULL,
	destino VARCHAR(20) NOT NULL,
	valorOperacao DECIMAL(10,2) NOT NULL,
	tipoOperacao ENUM('CT-e','MDF-e','CT-e E MDF-e') NOT NULL,
	observacaoSolicitacao TEXT NOT NULL,
	observacaoExtra TEXT NULL,
	arquivoPDF VARCHAR(255) NULL,
	status ENUM('Pendente','Concluído') DEFAULT 'Concluído' NOT NULL,
	dataSolicitacao TIMESTAMP NOT NULL,
	dataConclusao TIMESTAMP NULL
) ENGINE=InnoDB ROW_FORMAT=COMPRESSED; 

-- PROCEDURE DE ARQUIVAMENTO
DELIMITER //
CREATE PROCEDURE arquivar_requerimentos()
BEGIN
    -- Mover concluidos com mais de 30 dias para arquivados
    INSERT INTO tblarquivado 
    (id, nomeMotorista, placaCavalo, placaCarretas, destino, valorOperacao, tipoOperacao, observacaoSolicitacao, observacaoExtra, arquivoPDF, status, dataSolicitacao, dataConclusao)
    SELECT id, nomeMotorista, placaCavalo, placaCarretas, destino, valorOperacao, tipoOperacao, observacaoSolicitacao, observacaoExtra, arquivoPDF, status, dataSolicitacao, dataConclusao
    FROM tblsolicitacao
    WHERE status = 'Concluído' 
    AND dataConclusao < DATE_SUB(NOW(), INTERVAL 30 DAY);
    
    -- Remover dos ativos
    DELETE FROM tblsolicitacao
    WHERE status = 'Concluído'
    AND dataConclusao < DATE_SUB(NOW(), INTERVAL 30 DAY);
END //

SET GLOBAL event_scheduler = ON;

-- AGENDAR EXECUÇÃO DIÁRIA
CREATE EVENT evt_arquivamento_automatico
ON SCHEDULE EVERY 1 DAY
STARTS CURRENT_TIMESTAMP
DO
BEGIN
    CALL arquivar_requerimentos();
END //
DELIMITER ;


